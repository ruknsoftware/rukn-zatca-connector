{% set details = get_phase_2_print_format_details(doc) %}
{% if (details.siaf.invoice_type_transaction)[:2] == '01' %}
    {% set invoice_type = "Standard" %}
{% elif (details.siaf.invoice_type_transaction)[:2] == '02' %}
    {% set invoice_type = "Simplified" %}
{% endif %}

{% if letter_head %}
    <div class="letter-head">
        {{ letter_head }}
    </div>
{% endif %}
{% set lang = frappe["form_dict"]["_lang"] %}
{% if lang == "العربية" or lang == "اردو" or lang == "پارسی" %}
    {% set dir = "rtl" %}
{% else %}
    {% set dir = "ltr" %}
{% endif %}
{% if details and details.advance_payment_entry %}
<div class="text-center">
    {% if invoice_type == "Standard" %}

            <h2>{{ _("Standard Tax Invoice Credit Note") }}</h2>
        
    {% elif invoice_type == "Simplified" %}
        
            <h2>{{ _("Simplified Tax Invoice Credit Note") }}</h2>
    {% endif %}

    <div class="row">
        <div class="col-md-6">
            <b>{{ _("Invoice ID") }}</b>
            <p>{{ doc.name }}</p>
        </div>
        <div class="col-md-6">
        <span>
            <b>{{ _("Posting Date") }}</b>
            <p>{{ doc.get_formatted("posting_date") }}</p>
        </span>
        </div>
    </div>
    <hr>
    <table class="table table-bordered" dir={{ dir }}>
        <tr>
            <th>
                    {{ _("Seller Name") }}
            </th>
            <th>
                    {{ _("Address") }}
            </th>
            <th>
                <b>{{ _("Vat Registration Number") }}</b>
            </th>
            <th>
                <b>{{ _(details.seller_other_id_name) }}</b>
            </th>
        </tr>
        <tr>
            <td>{{ details.settings.company }}</td>
            <td>
                {{ details.address.street }},
                {{ details.address.district }},
                {{ details.address.city }},
                {{ details.address.postal_code }}
            </td>
            <td>{{ details.settings.vat_registration_number }}</td>
            <td>{{ details.seller_other_id or "" }}</td>
        </tr>
    </table>

    <table class="table table-bordered" dir="{{ dir }}">
        <tr>
            <th>
                {{ _("Buyer Name") }}
            </th>
            <th>
                    {{ _("Address") }}
            </th>
            <th>
                {{ _("Vat Registration Number") }}
            </th>
            <th>
                {{ _(details.buyer_other_id_name) }}</th>
        </tr>
        <tr>
            <td>{{ details.advance_payment_entry.party or "" }}</td>
            <td>
                {% if details.siaf %}
                    {{ details.siaf.buyer_street_name }},
                    {{ details.siaf.buyer_district }},
                    {{ details.siaf.buyer_city }},
                    {{ details.siaf.buyer_postal_code }}
                {% else %}
                    -
                {% endif %}
            </td>
            <td>
                {% if details.siaf %}
                    {{ details.siaf.buyer_vat_registration_number }}
                {% else %}
                    -
                {% endif %}
            </td>
            <td>{{ details.buyer_other_id or "" }}</td>
        </tr>
    </table>
        <table class="table table-bordered" dir={{ dir }}>
        <thead>
            <tr>
                <th>#</th>
                <th>{{ _("Products") }}</th>
                <th>{{ _("Quantity") }}</th>
                <th>{{ _("Unit Price") }}</th>
                <th>{{ _("Net Amount") }}</th>
                <th>{{ _("VAT %") }}</th>
                <th>{{ _("VAT Amount") }}</th>
                <th>{{ _("Total With VAT") }}</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>1</td>
                <td>
                    {{ details.advance_payment_entry.item_name }}
                    {% if details.advance_payment_entry.item_code != details.advance_payment_entry.item_name -%}
                    Item Code: {{ details.advance_payment_entry.item_code }}
                    {%- endif %}
                </td>
                <td>1</td>
                <td>
                    {{ frappe.utils.fmt_money(details.net_amount | default(0) | abs, None, doc.total_amount_currency) }}
                </td>
                <td>
                    {{ frappe.utils.fmt_money(details.net_amount | default(0) | abs, None, doc.total_amount_currency) }}
                </td>
                <td>{{ details.advance_payment_entry.tax_rate }}%</td>
                <td>
                    {{ frappe.utils.fmt_money(details.tax_amount | default(0) | abs, None, doc.total_amount_currency) }}
                </td>
                <td>
                    {{ frappe.utils.fmt_money(doc.accounts[0].debit_in_account_currency | default(0) | abs, None, doc.total_amount_currency) }}
                </td>

            </tr>
        </tbody>
        </table>
    <table class="table table-bordered" dir={{ dir }}>
        <tr>
            <td>{{ _("Taxable Amount") }}</td>
            <td>{{ frappe.utils.fmt_money(details.net_amount | default(0) | abs, None, doc.total_amount_currency) }}</td>
        </tr>
        <tr>
            <td>{{ _("VAT Amount") }}</td>
            <td>{{ frappe.utils.fmt_money(details.tax_amount | default(0) | abs, None, doc.total_amount_currency) }}</td>
        </tr>
        <tr>
            <td><b>{{ _("Total With VAT") }}</b></td>
            <td><b>{{ frappe.utils.fmt_money(doc.accounts[0].debit_in_account_currency | default(0) | abs, None, doc.total_amount_currency) }}</b></td>
                </tr>
            </table>

            <div class="text-center">
                {% if details.siaf.qr_image_src %}
                    <img src="{{ details.siaf.qr_image_src }}" width=200 height=200>
                {% else %}
                    <p class="text-danger">{{ _("QR Code not available") }}</p>
                {% endif %}
    </div>

            </div>

{% else %}
<div class="text-center text-danger">
    {{ _("No linked Advance Payment Entry found for this Journal Entry") }}
</div>
{% endif %}
